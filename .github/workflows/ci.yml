name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: Password123!
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P Password123! -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore tools
      run: dotnet tool restore
      
    - name: Set up SQL Server connection
      run: |
        # Set up user secrets for the ReadonlyTests project
        cd src/Highway.Data.ReadonlyTests
        dotnet user-secrets set "SqlConnectionString" "Server=localhost,1433;Database=HighwayDataTests;User ID=sa;Password=Password123!;TrustServerCertificate=true;"
        cd ../..
    
    - name: Create test database
      run: |
        # Install sqlcmd
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
        sudo apt-get update
        sudo apt-get install -y mssql-tools unixodbc-dev
        export PATH="$PATH:/opt/mssql-tools/bin"
        
        # Create test database
        sqlcmd -S localhost,1433 -U sa -P Password123! -Q "CREATE DATABASE HighwayDataTests;" || true
        
    - name: Build and test
      run: dotnet cake --target=TestAll
      env:
        SqlConnectionString: "Server=localhost,1433;Database=HighwayDataTests;User ID=sa;Password=Password123!;TrustServerCertificate=true;"